<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Verification - EventFinder</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-brand">
                <h2><i class="fas fa-calendar-alt"></i> EventFinder</h2>
                <p class="navbar-tagline">The Alternative</p>
            </div>
            <div class="navbar-right">
                <button id="backToHomeBtn" class="secondary-btn">
                    <i class="fas fa-home"></i> Back to Home
                </button>
            </div>
        </div>
    </nav>

    <!-- Verification Content -->
    <section class="verification-section">
        <div class="container">
            <div class="verification-container">
                <div class="verification-content">
                    <!-- Loading State -->
                    <div id="verificationLoading" class="verification-loading">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <h2>Verifying Your Email...</h2>
                        <p>Please wait while we verify your email address.</p>
                    </div>

                    <!-- Success State -->
                    <div id="verificationSuccess" class="verification-result success" style="display: none;">
                        <div class="result-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h2>Email Verified Successfully!</h2>
                        <p>Your account has been verified. You can now log in to EventFinder.</p>
                        <div class="verification-actions">
                            <button id="loginBtn" class="primary-btn">
                                <i class="fas fa-sign-in-alt"></i> Go to Login
                            </button>
                        </div>
                    </div>

                    <!-- Error State -->
                    <div id="verificationError" class="verification-result error" style="display: none;">
                        <div class="result-icon">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <h2>Verification Failed</h2>
                        <p id="errorMessage">There was an issue verifying your email address.</p>
                        <div class="verification-actions">
                            <button id="backHomeBtn" class="secondary-btn">
                                <i class="fas fa-home"></i> Back to Home
                            </button>
                            <button id="contactSupportBtn" class="primary-btn">
                                <i class="fas fa-envelope"></i> Contact Support
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const email = urlParams.get('email');

        // AWS API Base URL
        const AWS_API_BASE_URL = 'https://qk3jiyk1e8.execute-api.ap-south-1.amazonaws.com/prod';

        // DOM elements
        const loadingDiv = document.getElementById('verificationLoading');
        const successDiv = document.getElementById('verificationSuccess');
        const errorDiv = document.getElementById('verificationError');
        const errorMessage = document.getElementById('errorMessage');

        // Verify email on page load
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('Email verification started:', { token: token ? 'present' : 'missing', email });

            if (!token || !email) {
                showError('Invalid verification link. Missing token or email.');
                return;
            }

            try {
                console.log('Sending verification request...');
                const response = await fetch(`${AWS_API_BASE_URL}/verify-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: token,
                        email: email
                    })
                });

                console.log('Verification response status:', response.status);
                const data = await response.json();
                console.log('Verification response:', data);

                if (response.ok && data.success) {
                    showSuccess();
                } else {
                    showError(data.message || 'Email verification failed. Please try again.');
                }
            } catch (error) {
                console.error('Email verification error:', error);
                showError('Network error during verification. Please check your connection and try again.');
            }
        });

        function showSuccess() {
            loadingDiv.style.display = 'none';
            successDiv.style.display = 'block';
            errorDiv.style.display = 'none';
        }

        function showError(message) {
            loadingDiv.style.display = 'none';
            successDiv.style.display = 'none';
            errorDiv.style.display = 'block';
            errorMessage.textContent = message;
        }

        // Button event listeners
        document.getElementById('loginBtn')?.addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        document.getElementById('backHomeBtn')?.addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        document.getElementById('backToHomeBtn')?.addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        document.getElementById('contactSupportBtn')?.addEventListener('click', () => {
            window.location.href = `mailto:takudzwasamu@gmail.com?subject=Email Verification Issue&body=Hi, I'm having trouble verifying my email address: ${email}`;
        });
    </script>
</body>
</html>